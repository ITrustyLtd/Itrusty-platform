# Bank Balance Update Flowchart
## Visual Logic Flow

---

## ðŸ“¥ CUSTOMER TRANSACTION FLOW (Income)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USER ACTION                           â”‚
â”‚   Create/Edit Customer Transaction     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CHECK: Is there a bank_account?      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ YES              â”‚ NO
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ bank_account   â”‚    â”‚ âš ï¸ Skip balance â”‚
â”‚ specified      â”‚    â”‚ update          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CHECK: Is total_paid > 0?            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ YES              â”‚ NO
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ total_paid     â”‚    â”‚ âš ï¸ Skip balance â”‚
â”‚ has value      â”‚    â”‚ update          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DETERMINE ACTION TYPE                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º CREATE NEW
         â”‚    â””â”€â”€â–º Balance: +total_paid
         â”‚
         â”œâ”€â”€â–º EDIT AMOUNT
         â”‚    â””â”€â”€â–º Balance: +(new - old)
         â”‚
         â”œâ”€â”€â–º CHANGE ACCOUNT
         â”‚    â””â”€â”€â–º Old Acct: -total_paid
         â”‚         New Acct: +total_paid
         â”‚
         â””â”€â”€â–º DELETE
              â””â”€â”€â–º Balance: -total_paid (reversal)
```

---

## ðŸ“¤ SUPPLIER TRANSACTION FLOW (Expense)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USER ACTION                           â”‚
â”‚   Create/Edit Supplier Transaction     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CHECK: Is there a bank_account?      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ YES              â”‚ NO
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ bank_account   â”‚    â”‚ âš ï¸ Skip balance â”‚
â”‚ specified      â”‚    â”‚ update          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CHECK: Is amount > 0?                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ YES              â”‚ NO
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ amount has     â”‚    â”‚ âš ï¸ Skip balance â”‚
â”‚ value          â”‚    â”‚ update          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CHECK: Is status === 'Paid'?         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ YES              â”‚ NO (Pending/Scheduled)
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Status is Paid â”‚    â”‚ âš ï¸ Skip balance â”‚
â”‚ Proceed        â”‚    â”‚ update (wait)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DETERMINE ACTION TYPE                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º CREATE NEW (Status=Paid)
         â”‚    â””â”€â”€â–º Balance: -amount
         â”‚
         â”œâ”€â”€â–º STATUS CHANGE
         â”‚    â”œâ”€â”€â–º Pending â†’ Paid
         â”‚    â”‚    â””â”€â”€â–º Balance: -amount
         â”‚    â””â”€â”€â–º Paid â†’ Cancelled
         â”‚         â””â”€â”€â–º Balance: +amount (refund)
         â”‚
         â”œâ”€â”€â–º EDIT AMOUNT (Status=Paid)
         â”‚    â””â”€â”€â–º Balance: -(new - old)
         â”‚
         â”œâ”€â”€â–º CHANGE ACCOUNT (Status=Paid)
         â”‚    â””â”€â”€â–º Old Acct: +amount (reverse)
         â”‚         New Acct: -amount (apply)
         â”‚
         â””â”€â”€â–º DELETE (was Status=Paid)
              â””â”€â”€â–º Balance: +amount (reversal)
```

---

## ðŸ”§ UPDATE BANK ACCOUNT BALANCE FUNCTION

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   updateBankAccountBalance()            â”‚
â”‚   (bankAccountName, amountChange)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FIND ACCOUNT by name                  â”‚
â”‚   in bankAccounts array                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ FOUND            â”‚ NOT FOUND
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get account    â”‚    â”‚ âŒ Log error    â”‚
â”‚ object         â”‚    â”‚ Exit function   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CALCULATE NEW BALANCE                 â”‚
â”‚   newBalance = currentBalance + change  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API CALL: PATCH                       â”‚
â”‚   tables/financial_accounts/{id}        â”‚
â”‚   Body: { balance: newBalance }         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ SUCCESS          â”‚ FAIL
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Update      â”‚    â”‚ âŒ Log error    â”‚
â”‚ local cache    â”‚    â”‚ Transaction ok  â”‚
â”‚ localStorage   â”‚    â”‚ but balance not â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ’¡ EXAMPLE SCENARIOS

### Scenario 1: Simple Customer Payment
```
User Action:
  Add Transaction
  â””â”€ Customer: AGL
  â””â”€ Total Paid: â‚¬1000
  â””â”€ Bank: EUR CCB

Flow:
  âœ… bank_account exists
  âœ… total_paid > 0
  âœ… Action: CREATE NEW
  
Execution:
  updateBankAccountBalance("EUR CCB", +1000)
  â””â”€ Find EUR CCB account
  â””â”€ Current balance: â‚¬10,000
  â””â”€ New balance: â‚¬11,000
  â””â”€ PATCH API call
  â””â”€ âœ… Success

Result:
  EUR CCB balance: â‚¬10,000 â†’ â‚¬11,000
```

---

### Scenario 2: Supplier Payment Status Change
```
User Action:
  Edit Payment
  â””â”€ Status: Pending â†’ Paid
  â””â”€ Amount: Â¥5000
  â””â”€ Bank: CNY ICBC

Flow:
  âœ… bank_account exists
  âœ… amount > 0
  âœ… oldStatus = Pending (didn't affect balance)
  âœ… newStatus = Paid (now affects balance)
  âœ… Action: STATUS CHANGE (Pendingâ†’Paid)
  
Execution:
  updateBankAccountBalance("CNY ICBC", -5000)
  â””â”€ Find CNY ICBC account
  â””â”€ Current balance: Â¥20,000
  â””â”€ New balance: Â¥15,000
  â””â”€ PATCH API call
  â””â”€ âœ… Success

Result:
  CNY ICBC balance: Â¥20,000 â†’ Â¥15,000
```

---

### Scenario 3: Delete Customer Payment
```
User Action:
  Delete Transaction
  â””â”€ Customer: AGL
  â””â”€ Total Paid: â‚¬1000 (was recorded)
  â””â”€ Bank: EUR CCB

Flow:
  âœ… bank_account exists
  âœ… total_paid > 0
  âœ… Action: DELETE
  
Execution:
  updateBankAccountBalance("EUR CCB", -1000)
  â””â”€ Find EUR CCB account
  â””â”€ Current balance: â‚¬11,000
  â””â”€ New balance: â‚¬10,000 (reversal)
  â””â”€ PATCH API call
  â””â”€ âœ… Success

Result:
  EUR CCB balance: â‚¬11,000 â†’ â‚¬10,000
```

---

### Scenario 4: Change Bank Account
```
User Action:
  Edit Transaction
  â””â”€ Change Bank: EUR CCB â†’ USD CCB
  â””â”€ Amount: â‚¬500
  
Flow:
  âœ… bank_account changed
  âœ… total_paid > 0
  âœ… Action: CHANGE ACCOUNT
  
Execution:
  Step 1: updateBankAccountBalance("EUR CCB", -500)
          â””â”€ EUR CCB: â‚¬11,000 â†’ â‚¬10,500
  
  Step 2: updateBankAccountBalance("USD CCB", +500)
          â””â”€ USD CCB: $8,000 â†’ $8,500

Result:
  EUR CCB: â‚¬11,000 â†’ â‚¬10,500
  USD CCB: $8,000 â†’ $8,500
```

---

## ðŸ” DECISION TREE SUMMARY

### For Customer Transactions:
```
Has bank_account? â”€â”€YESâ”€â”€> Has total_paid? â”€â”€YESâ”€â”€> UPDATE BALANCE (+)
      â”‚                            â”‚
      NO                           NO
      â”‚                            â”‚
      â””â”€â”€> SKIP                    â””â”€â”€> SKIP
```

### For Supplier Transactions:
```
Has bank_account? â”€â”€YESâ”€â”€> Has amount? â”€â”€YESâ”€â”€> Status=Paid? â”€â”€YESâ”€â”€> UPDATE BALANCE (-)
      â”‚                         â”‚                      â”‚
      NO                        NO                     NO
      â”‚                         â”‚                      â”‚
      â””â”€â”€> SKIP                 â””â”€â”€> SKIP              â””â”€â”€> SKIP (wait for Paid)
```

---

**Key Principle:** Customer payments ALWAYS update when saved. Supplier payments ONLY update when status is "Paid".
